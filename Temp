Read below error and solve this error message quickly


PS C:\Users\W0024618\Desktop\apac-occupancy-backend> node server.js
ðŸš€ APAC server listening on port 3007
âœ… MSSQL (APAC) connected
RequestError: Incorrect syntax near the keyword 'AS'.
    at handleError (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\mssql\lib\tedious\request.js:384:15)
    at Connection.emit (node:events:518:28)
    at Connection.emit (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\connection.js:970:18)
    at RequestTokenHandler.onErrorMessage (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\handler.js:284:21)
    at Readable.<anonymous> (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\token-stream-parser.js:19:33)
    at Readable.emit (node:events:518:28)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushObjectMode (node:internal/streams/readable:538:3)
    at Readable.push (node:internal/streams/readable:393:5)
    at nextAsync (node:internal/streams/from:194:22) {
  code: 'EREQUEST',
  originalError: Error: Incorrect syntax near the keyword 'AS'.
      at handleError (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\mssql\lib\tedious\request.js:382:19)
      at Connection.emit (node:events:518:28)
      at Connection.emit (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\connection.js:970:18)
      at RequestTokenHandler.onErrorMessage (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\handler.js:284:21)
      at Readable.<anonymous> (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\token-stream-parser.js:19:33)
      at Readable.emit (node:events:518:28)
      at addChunk (node:internal/streams/readable:561:12)
      at readableAddChunkPushObjectMode (node:internal/streams/readable:538:3)
      at Readable.push (node:internal/streams/readable:393:5)
      at nextAsync (node:internal/streams/from:194:22) {
    info: ErrorMessageToken {
      name: 'ERROR',
      handlerName: 'onErrorMessage',
      number: 156,
      state: 1,
      class: 15,
      message: "Incorrect syntax near the keyword 'AS'.",
      serverName: 'SRVWUPNQ0986V',
      procName: '',
      lineNumber: 45
    }
  },
  number: 156,
  lineNumber: 45,
  state: 1,
  class: 15,
  serverName: 'SRVWUPNQ0986V',
  procName: '',
  precedingErrors: [
    RequestError: Incorrect syntax near the keyword 'AS'.
        at handleError (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\mssql\lib\tedious\request.js:384:15)
        at Connection.emit (node:events:518:28)
        at Connection.emit (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\connection.js:970:18)
        at RequestTokenHandler.onErrorMessage (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\handler.js:284:21)
        at Readable.<anonymous> (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\token-stream-parser.js:19:33)
        at Readable.emit (node:events:518:28)
        at addChunk (node:internal/streams/readable:561:12)
        at readableAddChunkPushObjectMode (node:internal/streams/readable:538:3)
        at Readable.push (node:internal/streams/readable:393:5)
        at nextAsync (node:internal/streams/from:194:22) {
      code: 'EREQUEST',
      originalError: [Error],
      number: 156,
      lineNumber: 24,
      state: 1,
      class: 15,
      serverName: 'SRVWUPNQ0986V',
      procName: ''
    }
  ]
}
PS C:\Users\W0024618\Desktop\apac-occupancy-backend> node server.js
ðŸš€ APAC server listening on port 3007
âœ… MSSQL (APAC) connected
RequestError: The column 'PartitionNameFriendly' was specified multiple times for 'Hist'.
    at handleError (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\mssql\lib\tedious\request.js:384:15)
    at Connection.emit (node:events:518:28)
    at Connection.emit (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\connection.js:970:18)
    at RequestTokenHandler.onErrorMessage (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\handler.js:284:21)
    at Readable.<anonymous> (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\token-stream-parser.js:19:33)
    at Readable.emit (node:events:518:28)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushObjectMode (node:internal/streams/readable:538:3)
    at Readable.push (node:internal/streams/readable:393:5)
    at nextAsync (node:internal/streams/from:194:22) {
  code: 'EREQUEST',
  originalError: Error: The column 'PartitionNameFriendly' was specified multiple times for 'Hist'.
      at handleError (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\mssql\lib\tedious\request.js:382:19)
      at Connection.emit (node:events:518:28)
      at Connection.emit (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\connection.js:970:18)
      at RequestTokenHandler.onErrorMessage (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\handler.js:284:21)
      at Readable.<anonymous> (C:\Users\W0024618\Desktop\apac-occupancy-backend\node_modules\tedious\lib\token\token-stream-parser.js:19:33)
      at Readable.emit (node:events:518:28)
      at addChunk (node:internal/streams/readable:561:12)
      at readableAddChunkPushObjectMode (node:internal/streams/readable:538:3)
      at Readable.push (node:internal/streams/readable:393:5)
      at nextAsync (node:internal/streams/from:194:22) {
    info: ErrorMessageToken {
      name: 'ERROR',
      handlerName: 'onErrorMessage',
      number: 8156,
      state: 1,
      class: 16,
      message: "The column 'PartitionNameFriendly' was specified multiple times for 'Hist'.",
      serverName: 'SRVWUPNQ0986V',
      procName: '',
      lineNumber: 2
    }
  },
  number: 8156,
  lineNumber: 2,
  state: 1,
  class: 16,
  serverName: 'SRVWUPNQ0986V',
  procName: '',
  precedingErrors: []
}






/**
 * Historical rawâ€data fetch for the past N days, all or by location.
 */


exports.fetchHistoricalData = async ({ days = 7, location = null }) => {
  const pool = await poolPromise;
  const parts = quoteList(partitionList);

  // Outerâ€query filter based on the alias
  const outerFilter = location
    ? `WHERE PartitionNameFriendly = @location`
    : `WHERE PartitionNameFriendly IN (${quoteList([
        'Pune','Quezon City','JP.Tokyo','MY.Kuala Lumpur','Taguig City'
      ])})`;

  const query = `
    WITH Hist AS (
      SELECT
        DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) AS LocaleMessageTime,
        t1.ObjectName1,
        t1.ObjectName2               AS Door,
        CASE WHEN t2.Int1 = 0 THEN t2.Text12 ELSE CAST(t2.Int1 AS NVARCHAR) END AS EmployeeID,
        t3.Name                      AS PersonnelType,
        t1.ObjectIdentity1           AS PersonGUID,

        -- 1) Remap raw PartitionName2 â†’ friendly name, or default if null
        COALESCE(
          CASE
            WHEN t1.ObjectName2 LIKE 'APAC_PI%'   THEN 'Taguig City'
            WHEN t1.ObjectName2 LIKE 'APAC_PH%'   THEN 'Quezon City'
            WHEN t1.ObjectName2 LIKE '%PUN%'      THEN 'Pune'
            WHEN t1.ObjectName2 LIKE 'APAC_JPN%'  THEN 'JP.Tokyo'
            WHEN t1.ObjectName2 LIKE 'APAC_MY%'   THEN 'MY.Kuala Lumpur'
            ELSE t1.PartitionName2
          END,
          'APAC.Default'            -- fallback default partition
        ) AS PartitionNameFriendly,

  COALESCE(
    CASE
      WHEN t1.ObjectName2 LIKE 'APAC_PI%'   THEN 'Taguig City'
      WHEN t1.ObjectName2 LIKE 'APAC_PH%'   THEN 'Quezon City'
      WHEN t1.ObjectName2 LIKE '%PUN%'      THEN 'Pune'
      WHEN t1.ObjectName2 LIKE 'APAC_JPN%'  THEN 'JP.Tokyo'
      WHEN t1.ObjectName2 LIKE 'APAC_MY%'   THEN 'MY.Kuala Lumpur'
      ELSE t1.PartitionName2
    END,
    'APAC.Default'          -- or whatever default you prefer
  ) AS PartitionNameFriendly,

        -- extract CardNumber
        COALESCE(
          TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID/Card)[1]','varchar(50)'),
          TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID)[1]','varchar(50)'),
          sc.value
        )                            AS CardNumber,
        t5d.value                    AS Direction
      FROM ACVSUJournal_00010028.dbo.ACVSUJournalLog t1
      JOIN ACVSCore.Access.Personnel       t2 ON t1.ObjectIdentity1 = t2.GUID
      JOIN ACVSCore.Access.PersonnelType   t3 ON t2.PersonnelTypeID = t3.ObjectID
      LEFT JOIN ACVSUJournal_00010028.dbo.ACVSUJournalLogxmlShred t5d
        ON t1.XmlGUID = t5d.GUID AND t5d.Value IN ('InDirection','OutDirection')
      LEFT JOIN ACVSUJournal_00010028.dbo.ACVSUJournalLogxml t_xml
        ON t1.XmlGUID = t_xml.GUID
      LEFT JOIN (
        SELECT GUID, value
        FROM ACVSUJournal_00010028.dbo.ACVSUJournalLogxmlShred
        WHERE Name IN ('Card','CHUID')
      ) AS sc
        ON t1.XmlGUID = sc.GUID
      WHERE
        t1.MessageType = 'CardAdmitted'
        -- date filter remains here
        AND CONVERT(DATE, DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC))
            >= DATEADD(DAY, -${days}, CONVERT(DATE, GETDATE()))
    )

    -- now filter by the newlyâ€defined alias
    SELECT *
    FROM Hist
    ${outerFilter}
    ORDER BY LocaleMessageTime ASC;
  `;

  const req = pool.request();
  if (location) {
    req.input('location', sql.NVarChar, location);
  }
  const result = await req.query(query);
  return result.recordset;
};


exports.fetchHistoricalOccupancy = async (location) =>
  exports.fetchHistoricalData({ days: 7, location: location || null });

